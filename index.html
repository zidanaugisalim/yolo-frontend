<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YOLO Demo (XAMPP + FastAPI)</title>
  <style>
  :root{
    --bg:#0b1020;
    --card:#111a33;
    --muted:#a7b0d4;
    --text:#eef1ff;
    --border:rgba(255,255,255,.12);
    --accent:#6ea8fe;
    --ok:#3ddc97;
    --warn:#ffcc66;
    --err:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans";
    background: radial-gradient(1200px 800px at 20% -10%, rgba(110,168,254,.25), transparent 60%),
                radial-gradient(900px 600px at 90% 10%, rgba(61,220,151,.18), transparent 55%),
                var(--bg);
    color:var(--text);
  }
  .wrap{max-width:1080px;margin:26px auto;padding:0 14px}
  .title{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;flex-wrap:wrap}
  h2{margin:0;font-size:26px;letter-spacing:.2px}
  .sub{color:var(--muted);margin:6px 0 0 0;font-size:13.5px;line-height:1.4}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border:1px solid var(--border);
    border-radius:999px;background:rgba(255,255,255,.04);
    color:var(--muted);font-size:13px;
  }
  .dot{width:9px;height:9px;border-radius:50%;background:var(--warn)}
  .dot.ok{background:var(--ok)}
  .dot.err{background:var(--err)}
  .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
  @media(min-width:900px){
    .grid-2{grid-template-columns: 1fr 1fr;}
    .grid-3{grid-template-columns: 1.15fr .85fr;}
  }
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  input[type="text"], input[type="url"]{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:rgba(0,0,0,.18);
    color:var(--text);
    outline:none;
  }
  input[type="file"]{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px dashed var(--border);
    background:rgba(0,0,0,.12);
    color:var(--muted);
  }
  button{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    background:rgba(110,168,254,.16);
    color:var(--text);
    cursor:pointer;
    font-weight:600;
  }
  button:hover{background:rgba(110,168,254,.24)}
  button:disabled{opacity:.55;cursor:not-allowed}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .muted{color:var(--muted);font-size:13px;line-height:1.4}
  .section-title{margin:0 0 10px 0;font-size:16px}
  img, video{
    max-width:100%;
    border-radius:14px;
    border:1px solid var(--border);
    background:rgba(0,0,0,.18);
  }
  .two{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.two{grid-template-columns:1fr 1fr}}
  pre{
    background:rgba(0,0,0,.25);
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    overflow:auto;
    max-height:420px;
    color:#d9e1ff;
    font-size:12.5px;
  }
  .kpis{
    display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
  }
  .kpi{
    padding:8px 10px;border-radius:12px;border:1px solid var(--border);
    background:rgba(0,0,0,.16);
    color:var(--muted);font-size:13px
  }
  .kpi b{color:var(--text)}
  .footer{margin:18px 0 28px 0;color:var(--muted);font-size:12.5px}
  a{color:var(--accent)}
</style>

</head>
<body>
  <div class="wrap">
  <div class="title">
    <div>
      <h2>YOLOv8 Object Detection Demo</h2>
      <p class="sub">
        Frontend: Vercel • Backend: FastAPI + YOLOv8 (via Cloudflare Tunnel).
        Upload gambar untuk deteksi + lihat JSON. Kamera opsional untuk demo.
      </p>
    </div>

    <div class="pill" id="statusPill">
      <span class="dot" id="statusDot"></span>
      <span id="statusText">status: idle</span>
    </div>
  </div>


  <div class="card">
    <label>Backend URL (biarkan default):</label>
    <input id="api" value="https://nested-forty-entire-constitutional.trycloudflare.com/" />
    <p class="small">Kalau port backend beda, ganti di sini.</p>
  </div>

  <div class="row">
    <div class="card">
      <h3>Upload Gambar</h3>
      <input id="file" type="file" accept="image/*" />
      <p style="margin-top:10px">
        <button id="run">Detect (Image + JSON)</button>
      </p>
      <h4>Hasil Gambar Deteksi</h4>
      <img id="outImg" alt="hasil deteksi akan muncul di sini" />
    </div>

    <div class="card">
      <h3>Hasil JSON</h3>
      <pre id="outJson">{}</pre>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <h3>Realtime Camera (opsional)</h3>
      <p class="small">
        Ini realtime sederhana: ambil frame dari kamera tiap 1 detik, kirim ke backend, tampilkan hasilnya.
      </p>
      <video id="vid" autoplay playsinline></video>
      <p style="margin-top:10px">
        <button id="startCam">Start Camera</button>
        <button id="stopCam">Stop</button>
      </p>
      <h4>Hasil Deteksi Kamera</h4>
      <img id="camOut" />
    </div>
  </div>

  <script>
    const apiEl = document.getElementById("api");
    const fileEl = document.getElementById("file");
    const outImg = document.getElementById("outImg");
    const outJson = document.getElementById("outJson");
    const runBtn = document.getElementById("run");

    function setStatus(type, text){
  const dot = document.getElementById("statusDot");
  const t = document.getElementById("statusText");
  dot.className = "dot" + (type ? " " + type : "");
  t.textContent = text;
}

function applyApiFromQuery(){
  const p = new URLSearchParams(location.search);
  const api = p.get("api");
  if(api){
    apiEl.value = api.replace(/\/$/, "");
  }
}
applyApiFromQuery();

    function baseUrl() {
      return apiEl.value.replace(/\/$/, "");
    }

    runBtn.onclick = async () => {
  if (!fileEl.files[0]) return alert("Pilih gambar dulu!");
  if (!apiEl.value) return alert("Backend URL belum diisi!");

  const base = baseUrl();
  const f = fileEl.files[0];

  try{
    runBtn.disabled = true;
    setStatus("", "status: checking backend...");
    outJson.textContent = "Checking backend...";

    // ping backend
    const ping = await fetch(base + "/", { method: "GET" });
    if(!ping.ok) throw new Error("Backend tidak merespon dengan OK.");

    setStatus("ok", "status: processing...");
    outJson.textContent = "Loading JSON...";

    // JSON
    const form1 = new FormData();
    form1.append("file", f);
    const r1 = await fetch(base + "/predict-json", { method: "POST", body: form1 });
    if(!r1.ok) throw new Error("predict-json gagal: " + r1.status);
    const j = await r1.json();
    outJson.textContent = JSON.stringify(j, null, 2);

    // ringkasan deteksi (kalau elemen ringkasan ada)
    const total = j.total ?? j.num_detections ?? (j.predictions ? j.predictions.length : 0);
    const classes = (j.predictions || []).map(x => x.class_name).filter(Boolean);
    const uniq = [...new Set(classes)];
    const kpi1 = document.getElementById("kpiTotal");
    const kpi2 = document.getElementById("kpiClasses");
    if(kpi1) kpi1.innerHTML = `<b>${total}</b> detections`;
    if(kpi2) kpi2.innerHTML = `<b>${uniq.length ? uniq.join(", ") : "-"}</b> classes`;

    // Image
    const form2 = new FormData();
    form2.append("file", f);
    const r2 = await fetch(base + "/predict-image", { method: "POST", body: form2 });
    if(!r2.ok) throw new Error("predict-image gagal: " + r2.status);
    const blob = await r2.blob();
    outImg.src = URL.createObjectURL(blob);

    setStatus("ok", "status: done ✅");
  }catch(e){
    console.error(e);
    setStatus("err", "status: error ❌");
    outJson.textContent = "ERROR: " + (e?.message || e);
    alert("Gagal. Cek status backend URL / tunnel. Detail ada di panel JSON.");
  }finally{
    runBtn.disabled = false;
  }
};


    // ===== camera (simple realtime) =====
    const vid = document.getElementById("vid");
    const camOut = document.getElementById("camOut");
    const startCam = document.getElementById("startCam");
    const stopCam = document.getElementById("stopCam");
    let stream = null;
    let timer = null;

    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], {type:mime});
    }

    async function sendFrame() {
      if (!stream) return;
      const canvas = document.createElement("canvas");
      canvas.width = vid.videoWidth || 640;
      canvas.height = vid.videoHeight || 480;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(vid, 0, 0, canvas.width, canvas.height);

      const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
      const blob = dataURLtoBlob(dataUrl);

      const form = new FormData();
      form.append("file", blob, "frame.jpg");
      const r = await fetch(baseUrl() + "/predict-image", { method: "POST", body: form });
      const out = await r.blob();
      camOut.src = URL.createObjectURL(out);
    }

    startCam.onclick = async () => {
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      vid.srcObject = stream;
      await new Promise(res => vid.onloadedmetadata = res);

      if (timer) clearInterval(timer);
      timer = setInterval(sendFrame, 1000); // 1 detik sekali (biar ringan)
    };

    stopCam.onclick = () => {
      if (timer) clearInterval(timer);
      timer = null;
      if (stream) stream.getTracks().forEach(t => t.stop());
      stream = null;
      vid.srcObject = null;
    };
  </script>
</body>
</html>
