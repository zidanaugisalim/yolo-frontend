<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YOLO Demo (XAMPP + FastAPI)</title>
  <style>
    body{font-family:Arial;max-width:1000px;margin:20px auto;padding:0 12px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;flex:1;min-width:300px}
    img,video{max-width:100%;border-radius:10px;border:1px solid #eee}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;cursor:pointer}
    input{padding:8px;border-radius:10px;border:1px solid #ccc;width:100%}
    pre{background:#f6f6f6;border-radius:10px;padding:10px;overflow:auto}
    .small{color:#555;font-size:13px}
  </style>
</head>
<body>
  <h2>YOLOv8 Object Detection (XAMPP Website + FastAPI Backend)</h2>
  <p class="small">
    Backend harus jalan di <b>http://127.0.0.1:8000</b>. Website ini jalan di <b>http://localhost/yolo-demo</b>.
  </p>

  <div class="card">
    <label>Backend URL (biarkan default):</label>
    <input id="api" value="https://stickers-republican-dreams-instrumentation.trycloudflare.com" />
    <p class="small">Kalau port backend beda, ganti di sini.</p>
  </div>

  <div class="row">
    <div class="card">
      <h3>Upload Gambar</h3>
      <input id="file" type="file" accept="image/*" />
      <p style="margin-top:10px">
        <button id="run">Detect (Image + JSON)</button>
      </p>
      <h4>Hasil Gambar Deteksi</h4>
      <img id="outImg" alt="hasil deteksi akan muncul di sini" />
    </div>

    <div class="card">
      <h3>Hasil JSON</h3>
      <pre id="outJson">{}</pre>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <h3>Realtime Camera (opsional)</h3>
      <p class="small">
        Ini realtime sederhana: ambil frame dari kamera tiap 1 detik, kirim ke backend, tampilkan hasilnya.
      </p>
      <video id="vid" autoplay playsinline></video>
      <p style="margin-top:10px">
        <button id="startCam">Start Camera</button>
        <button id="stopCam">Stop</button>
      </p>
      <h4>Hasil Deteksi Kamera</h4>
      <img id="camOut" />
    </div>
  </div>

  <script>
    const apiEl = document.getElementById("api");
    const fileEl = document.getElementById("file");
    const outImg = document.getElementById("outImg");
    const outJson = document.getElementById("outJson");
    const runBtn = document.getElementById("run");

    function baseUrl() {
      return apiEl.value.replace(/\/$/, "");
    }

    runBtn.onclick = async () => {
      if (!fileEl.files[0]) return alert("Pilih gambar dulu!");
      outJson.textContent = "Loading...";

      const f = fileEl.files[0];

      // JSON
      const form1 = new FormData();
      form1.append("file", f);
      const r1 = await fetch(baseUrl() + "/predict-json", { method: "POST", body: form1 });
      const j = await r1.json();
      outJson.textContent = JSON.stringify(j, null, 2);

      // Image
      const form2 = new FormData();
      form2.append("file", f);
      const r2 = await fetch(baseUrl() + "/predict-image", { method: "POST", body: form2 });
      const blob = await r2.blob();
      outImg.src = URL.createObjectURL(blob);
    };

    // ===== camera (simple realtime) =====
    const vid = document.getElementById("vid");
    const camOut = document.getElementById("camOut");
    const startCam = document.getElementById("startCam");
    const stopCam = document.getElementById("stopCam");
    let stream = null;
    let timer = null;

    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], {type:mime});
    }

    async function sendFrame() {
      if (!stream) return;
      const canvas = document.createElement("canvas");
      canvas.width = vid.videoWidth || 640;
      canvas.height = vid.videoHeight || 480;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(vid, 0, 0, canvas.width, canvas.height);

      const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
      const blob = dataURLtoBlob(dataUrl);

      const form = new FormData();
      form.append("file", blob, "frame.jpg");
      const r = await fetch(baseUrl() + "/predict-image", { method: "POST", body: form });
      const out = await r.blob();
      camOut.src = URL.createObjectURL(out);
    }

    startCam.onclick = async () => {
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      vid.srcObject = stream;
      await new Promise(res => vid.onloadedmetadata = res);

      if (timer) clearInterval(timer);
      timer = setInterval(sendFrame, 1000); // 1 detik sekali (biar ringan)
    };

    stopCam.onclick = () => {
      if (timer) clearInterval(timer);
      timer = null;
      if (stream) stream.getTracks().forEach(t => t.stop());
      stream = null;
      vid.srcObject = null;
    };
  </script>
</body>
</html>
